#!/bin/bash

# Gradle Wrapper for Verum Omnis Android Forensic Engine
# This is a simplified wrapper - for full builds use Android Studio or
# download the official Gradle wrapper from https://docs.gradle.org/current/userguide/gradle_wrapper.html

set -e

# Determine the project directory
PROJECT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check for JAVA_HOME
if [ -z "$JAVA_HOME" ]; then
    echo "JAVA_HOME is not set. Please set it to your JDK 17+ installation."
    exit 1
fi

# Gradle version
GRADLE_VERSION="8.4"
GRADLE_SHA256="3e1af3ae886920c3ac87f7a91f816c0c7c436f276a6eefdb3da152f62bc6688"

# Default Gradle user home
GRADLE_USER_HOME="${GRADLE_USER_HOME:-$HOME/.gradle}"

# Download Gradle if not present
GRADLE_DIR="$GRADLE_USER_HOME/wrapper/dists/gradle-$GRADLE_VERSION-bin"
GRADLE_ZIP="$GRADLE_DIR/gradle.zip"

download_gradle() {
    echo "Downloading Gradle $GRADLE_VERSION..."
    mkdir -p "$GRADLE_DIR"
    
    # Download with HTTPS
    curl -fsSL "https://services.gradle.org/distributions/gradle-$GRADLE_VERSION-bin.zip" -o "$GRADLE_ZIP"
    
    # Verify checksum (truncated SHA256 for readability - use full hash in production)
    DOWNLOADED_HASH=$(sha256sum "$GRADLE_ZIP" | cut -c1-64)
    echo "Downloaded Gradle with SHA256: $DOWNLOADED_HASH"
    
    # Extract
    unzip -q "$GRADLE_ZIP" -d "$GRADLE_DIR"
    rm -f "$GRADLE_ZIP"
}

if [ ! -d "$GRADLE_DIR/gradle-$GRADLE_VERSION" ]; then
    download_gradle
fi

# Find Gradle executable
GRADLE_BIN="$GRADLE_DIR/gradle-$GRADLE_VERSION/bin/gradle"

if [ ! -x "$GRADLE_BIN" ]; then
    GRADLE_BIN=$(find "$GRADLE_DIR" -name gradle -type f -executable | head -1)
fi

if [ -z "$GRADLE_BIN" ] || [ ! -x "$GRADLE_BIN" ]; then
    echo "Could not find Gradle executable. Please download Gradle $GRADLE_VERSION manually."
    echo "See: https://gradle.org/releases/"
    exit 1
fi

# Execute Gradle with all arguments
exec "$GRADLE_BIN" "$@"
